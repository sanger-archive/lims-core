<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Lims::Core::Persistence::Session
  
    &mdash; Documentation by YARD 0.7.3
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '../../..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../../../_index.html">Index (S)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../../../Lims.html" title="Lims (module)">Lims</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Core.html" title="Lims::Core (module)">Core</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Persistence.html" title="Lims::Core::Persistence (module)">Persistence</a></span></span>
     &raquo; 
    <span class="title">Session</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Lims::Core::Persistence::Session
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Lims::Core::Persistence::Session</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
      <dt class="r2">Extended by:</dt>
      <dd class="r2">Forwardable</dd>
      
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/lims-core/persistence/session.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>A session is in charge of restoring and saving object throug the
persistence layer. A Session can not normally be created by the end user.
It has to be in a Store::with_session block, which acts has a transaction
and save/update everything at the end of it. It should also provides an
identity map. Session information (user, time) are also associated to the
modifications of those objects.</p>


  </div>
</div>
<div class="tags">
  

</div><div id="subclasses">
  <h2>Direct Known Subclasses</h2>
  <p class="children"><span class='object_link'><a href="Logger/Session.html" title="Lims::Core::Persistence::Logger::Session (class)">Logger::Session</a></span>, <span class='object_link'><a href="Sequel/Session.html" title="Lims::Core::Persistence::Sequel::Session (class)">Lims::Core::Persistence::Sequel::Session</a></span></p>
</div>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="UnmanagedObjectError-constant" class="">UnmanagedObjectError =
          
        </dt>
        <dd><pre class="code"><span class='const'>Class</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='const'>RuntimeError</span><span class='rparen'>)</span></pre></dd>
      
    </dl>
  


  


  

  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#%3C%3C-instance_method" title="#&lt;&lt; (instance method)">- (Object) <strong>&lt;&lt;</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Tell the session to be responsible of an object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Mark an object as to be deleted.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#delete_in_real-instance_method" title="#delete_in_real (instance method)">- (Object) <strong>delete_in_real</strong>(object, *options) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Call to.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#filter_persistor-instance_method" title="#filter_persistor (instance method)">- (Persistor) <strong>filter_persistor</strong>(persistor) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create a new persistor sharing the same internal parameters but with the
"context" (datasest) of the new one.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#id_for-instance_method" title="#id_for (instance method)">- (Id<sup>?</sup>) <strong>id_for</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the id of an object if exists.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#id_for%21-instance_method" title="#id_for! (instance method)">- (Id) <strong>id_for!</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the id of an object and save it if necessary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Session) <strong>initialize</strong>(store, *params) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>param [Store] store the underlying store.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#managed%3F-instance_method" title="#managed? (instance method)">- (Boolean) <strong>managed?</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if the session 'mananage' already this object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#method_missing-instance_method" title="#method_missing (instance method)">- (Object) <strong>method_missing</strong>(name, *args, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#on_object_load-instance_method" title="#on_object_load (instance method)">- (Object) <strong>on_object_load</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Called by Persistor to inform the session about the loading of an object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persistor_for-instance_method" title="#persistor_for (instance method)">- (Persistor<sup>?</sup>) <strong>persistor_for</strong>(object) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the persistor corresponding to the object class.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#persistor_for_persistor_class-instance_method" title="#persistor_for_persistor_class (instance method)">- (Persistor) <strong>persistor_for_persistor_class</strong>(klass) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Find the first persistor of the specified class.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#persistor_name_for-instance_method" title="#persistor_name_for (instance method)">- (String) <strong>persistor_name_for</strong>(object) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Compute the class name of the persistor corresponding to the argument.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#save-instance_method" title="#save (instance method)">- (Boolean) <strong>save</strong>(object, *options) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>save the object in real.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#save_all-instance_method" title="#save_all (instance method)">- (Object) <strong>save_all</strong> </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>save all objects which needs to be.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_session-instance_method" title="#with_session (instance method)">- (Object) <strong>with_session</strong>(*params) {|session| ... }</a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Execute a block and save every 'marked' object in a transaction at the end.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Lims::Core::Persistence::Session (class)">Session</a></span></tt>) <strong>initialize</strong>(store, *params) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>param [Store] store the underlying store.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


21
22
23
24
25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 21</span>

<span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span><span class='id store'>store</span><span class='comma'>,</span> <span class='op'>*</span><span class='id params'>params</span><span class='rparen'>)</span>
  <span class='ivar'>@store</span> <span class='op'>=</span> <span class='id store'>store</span>
  <span class='ivar'>@objects</span> <span class='op'>=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='ivar'>@to_delete</span> <span class='op'>=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='ivar'>@in_session</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@saved</span> <span class='op'>=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='ivar'>@persistor_map</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>
<div id="method_missing_details" class="method_details_list">
  <h2>Dynamic Method Handling</h2>
  <p class="notice this">
    This class handles dynamic methods through the <tt>method_missing</tt> method
    
  </p>
  
    <div class="method_details first">
  <p class="signature first" id="method_missing-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>method_missing</strong>(name, *args, &amp;block) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 73</span>

<span class='kw'>def</span> <span class='id method_missing'>method_missing</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='op'>*</span><span class='id args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id block'>block</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>NameError</span>
    <span class='kw'>super</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='op'>*</span><span class='id args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id block'>block</span><span class='rparen'>)</span>         
  <span class='kw'>end</span> 
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="<<-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>&lt;&lt;</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Tell the session to be responsible of an object. The object will be saved
at the end of the session.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h3>Examples:</h3>
    
      <h4><div class='inline'></div></h4>
      <pre class="example code"><span class='id store'>store</span><span class='period'>.</span><span class='id with_session'>with_session</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id session'>session</span><span class='op'>|</span>
  <span class='id session'>session</span> <span class='op'>&lt;&lt;</span> <span class='const'>Plate</span><span class='period'>.</span><span class='id new'>new</span>
<span class='kw'>end</span></pre>
    
  </div>
<h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt>Persistable</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the object to persist.</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>the session, to allow for chaining</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 55</span>

<span class='kw'>def</span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@objects</span> <span class='op'>&lt;&lt;</span> <span class='id object'>object</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="delete-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>delete</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Mark an object as to be deleted. The corresponding object will be deleted
at the end of the session. For most object you don't need to load it to
delete it but some needs (to delete the appropriate children). The real
delete is made by calling the <span class='object_link'><a href="#delete_in_real-instance_method" title="Lims::Core::Persistence::Session#delete_in_real (method)">#delete_in_real</a></span> method.</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="#UnmanagedObjectError-constant" title="Lims::Core::Persistence::Session::UnmanagedObjectError (constant)">UnmanagedObjectError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


119
120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 119</span>

<span class='kw'>def</span> <span class='id delete'>delete</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='id raise'>raise</span> <span class='const'>UnmanagedObjectError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>can't delete </span><span class='embexpr_beg'>#{</span><span class='id object'>object</span><span class='period'>.</span><span class='id inspect'>inspect</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id managed?'>managed?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@to_delete</span> <span class='op'>&lt;&lt;</span> <span class='id object'>object</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="delete_in_real-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>delete_in_real</strong>(object, *options)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Call to</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>RuntimeError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


141
142
143
144
145
146
147</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 141</span>

<span class='kw'>def</span> <span class='id delete_in_real'>delete_in_real</span><span class='lparen'>(</span><span class='id object'>object</span><span class='comma'>,</span> <span class='op'>*</span><span class='id options'>options</span><span class='rparen'>)</span>
  <span class='id raise'>raise</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Can't delete an object inside a session. Please considere the 'delete' method instead.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='ivar'>@save_in_progress</span>
  <span class='kw'>return</span> <span class='id id_for'>id_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@saved</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@saved</span> <span class='op'>&lt;&lt;</span> <span class='id object'>object</span>

  <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span><span class='period'>.</span><span class='id delete'>delete</span><span class='lparen'>(</span><span class='id object'>object</span><span class='comma'>,</span> <span class='op'>*</span><span class='id options'>options</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="filter_persistor-instance_method">
  
    - (<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>) <strong>filter_persistor</strong>(persistor)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Create a new persistor sharing the same internal parameters but with the
"context" (datasest) of the new one. This can be used to "reset" a filtered
persistor to the current session.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>persistor</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


154
155
156
157
158
159
160
161
162
163</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 154</span>

<span class='kw'>def</span> <span class='id filter_persistor'>filter_persistor</span><span class='lparen'>(</span><span class='id persistor'>persistor</span><span class='rparen'>)</span>
  <span class='comment'># If the persistor session is the current session, there is nothing to do
</span>  <span class='comment'># just return the object as it is.
</span>    <span class='kw'>return</span> <span class='id persistor'>persistor</span> <span class='kw'>if</span>  <span class='id persistor'>persistor</span><span class='period'>.</span><span class='id instance_eval'>instance_eval</span> <span class='lbrace'>{</span><span class='ivar'>@session</span><span class='rbrace'>}</span> <span class='op'>==</span> <span class='kw'>self</span>

    <span class='comment'># we need first to find the original persistor, ie the one  that the user can call via
</span>    <span class='comment'># session.model
</span>    <span class='id original'>original</span> <span class='op'>=</span> <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id persistor'>persistor</span><span class='period'>.</span><span class='id class'>class</span><span class='rparen'>)</span>
    <span class='id persistor'>persistor</span><span class='period'>.</span><span class='id class'>class</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id original'>original</span><span class='comma'>,</span> <span class='id persistor'>persistor</span><span class='period'>.</span><span class='id dataset'>dataset</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="id_for-instance_method">
  
    - (<tt>Id</tt><sup>?</sup>) <strong>id_for</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns the id of an object if exists.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resource.html" title="Lims::Core::Resource (module)">Resource</a></span></tt>, <tt>Id</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>or id.</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Id</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


91
92
93
94
95
96</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 91</span>

<span class='kw'>def</span> <span class='id id_for'>id_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id object'>object</span>
  <span class='kw'>when</span> <span class='const'>Resource</span> <span class='kw'>then</span> <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span><span class='period'>.</span><span class='id id_for'>id_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='kw'>else</span> <span class='id object'>object</span> <span class='comment'># the object should be already an id
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="id_for!-instance_method">
  
    - (<tt>Id</tt>) <strong>id_for!</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns the id of an object and save it if necessary</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resource.html" title="Lims::Core::Resource (module)">Resource</a></span></tt>, <tt>Id</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>or id.</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Id</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


101
102
103
104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 101</span>

<span class='kw'>def</span> <span class='id id_for!'>id_for!</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id object'>object</span>
  <span class='id id_for'>id_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id save'>save</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="managed?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>managed?</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Check if the session 'mananage' already this object. .i.e if it's been
loaded or meant to be saved</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resource.html" title="Lims::Core::Resource (module)">Resource</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 110</span>

<span class='kw'>def</span> <span class='id managed?'>managed?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@objects</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="on_object_load-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>on_object_load</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Called by Persistor to inform the session about the loading of an object.
MUST be called by persistors creating Resources.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


84
85
86</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 84</span>

<span class='kw'>def</span> <span class='id on_object_load'>on_object_load</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='kw'>self</span> <span class='op'>&lt;&lt;</span> <span class='id object'>object</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="persistor_for-instance_method">
  
    - (<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt><sup>?</sup>) <strong>persistor_for</strong>(object) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Get the persistor corresponding to the object class</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resource.html" title="Lims::Core::Resource (module)">Resource</a></span></tt>, <tt>String</tt>, <tt>Symbol</tt>, <tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183
184
185
186
187
188
189
190
191
192</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 181</span>

<span class='kw'>def</span> <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id object'>object</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Persistor</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id filter_persistor'>filter_persistor</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id name'>name</span> <span class='op'>=</span> <span class='id persistor_name_for'>persistor_name_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
    <span class='ivar'>@persistor_map</span><span class='lbracket'>[</span><span class='id name'>name</span><span class='rbracket'>]</span>  <span class='op'>||=</span> <span class='kw'>begin</span> 
      <span class='id persistor_class'>persistor_class</span> <span class='op'>=</span> <span class='ivar'>@store</span><span class='period'>.</span><span class='id base_module'>base_module</span><span class='period'>.</span><span class='id constant'>constant</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>
      <span class='id raise'>raise</span> <span class='const'>NameError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Persistor </span><span class='embexpr_beg'>#{</span><span class='id name'>name</span><span class='rbrace'>}</span><span class='tstring_content'> not defined for </span><span class='embexpr_beg'>#{</span><span class='ivar'>@store</span><span class='period'>.</span><span class='id base_module'>base_module</span><span class='period'>.</span><span class='id name'>name</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id persistor_class'>persistor_class</span> <span class='op'>&amp;&amp;</span>  <span class='id persistor_class'>persistor_class</span><span class='period'>.</span><span class='id ancestors'>ancestors</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='const'>Persistor</span><span class='rparen'>)</span>
      <span class='id persistor_class'>persistor_class</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="persistor_for_persistor_class-instance_method">
  
    - (<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>) <strong>persistor_for_persistor_class</strong>(klass)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Find the first persistor of the specified class. Optimize if needed.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'></span>
      
      
        <span class='type'>(<tt>Class</tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Persistor.html" title="Lims::Core::Persistence::Persistor (class)">Persistor</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


169
170
171
172
173</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 169</span>

<span class='kw'>def</span> <span class='id persistor_for_persistor_class'>persistor_for_persistor_class</span><span class='lparen'>(</span><span class='id klass'>klass</span><span class='rparen'>)</span>
  <span class='ivar'>@persistor_map</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id persistor'>persistor</span><span class='op'>|</span>
    <span class='kw'>return</span> <span class='id persistor'>persistor</span> <span class='kw'>if</span> <span class='id persistor'>persistor</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='id klass'>klass</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="persistor_name_for-instance_method">
  
    - (<tt>String</tt>) <strong>persistor_name_for</strong>(object)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Compute the class name of the persistor corresponding to the argument</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>object</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resource.html" title="Lims::Core::Resource (module)">Resource</a></span></tt>, <tt>String</tt>, <tt>Symbol</tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200
201
202
203
204
205
206
207
208
209
210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 198</span>

<span class='kw'>def</span>  <span class='id persistor_name_for'>persistor_name_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id object'>object</span>
  <span class='kw'>when</span> <span class='const'>String</span> <span class='kw'>then</span> <span class='id object'>object</span>
  <span class='kw'>when</span> <span class='const'>Symbol</span> <span class='kw'>then</span> <span class='id object'>object</span><span class='period'>.</span><span class='id to_s'>to_s</span>
  <span class='kw'>when</span> <span class='const'>Class</span><span class='comma'>,</span><span class='const'>Module</span>
    <span class='kw'>if</span> <span class='id object'>object</span><span class='period'>.</span><span class='id respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:base_class</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id persistor_name_for'>persistor_name_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='period'>.</span><span class='id base_class'>base_class</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id object'>object</span><span class='period'>.</span><span class='id name'>name</span><span class='period'>.</span><span class='id sub'>sub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^Lims::Core::(Persistence::)?\w+::</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span> <span class='id persistor_name_for'>persistor_name_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='period'>.</span><span class='id class'>class</span><span class='rparen'>)</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id upper_camelcase'>upper_camelcase</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="save-instance_method">
  
    - (<tt>Boolean</tt>) <strong>save</strong>(object, *options) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>save the object in real. To mark an object as 'to save' use the `&lt;&lt;`
method Note we can't make this method private because, the persistor need
it to save their children. To solve this, we raise an exception if it's
inside a sess</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>RuntimeError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


65
66
67
68
69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 65</span>

<span class='kw'>def</span> <span class='id save'>save</span><span class='lparen'>(</span><span class='id object'>object</span><span class='comma'>,</span> <span class='op'>*</span><span class='id options'>options</span><span class='rparen'>)</span>
  <span class='id raise'>raise</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Can't save object inside a session. Please considere the &lt;&lt; method.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='ivar'>@save_in_progress</span>
  <span class='kw'>return</span> <span class='id id_for'>id_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@saved</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@saved</span> <span class='op'>&lt;&lt;</span> <span class='id object'>object</span>

  <span class='id persistor_for'>persistor_for</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span><span class='period'>.</span><span class='id save'>save</span><span class='lparen'>(</span><span class='id object'>object</span><span class='comma'>,</span> <span class='op'>*</span><span class='id options'>options</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="save_all-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>save_all</strong>  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>save all objects which needs to be</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130
131
132
133
134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 126</span>

<span class='kw'>def</span> <span class='id save_all'>save_all</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@store</span><span class='period'>.</span><span class='id transaction'>transaction</span> <span class='kw'>do</span>
    <span class='ivar'>@save_in_progress</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='comment'># allows saving
</span>    <span class='ivar'>@objects</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id object'>object</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='ivar'>@to_delete</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
        <span class='id delete_in_real'>delete_in_real</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id save'>save</span><span class='lparen'>(</span><span class='id object'>object</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='ivar'>@save_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="with_session-instance_method">
  
    - (<tt><span class='object_link'><a href="../../../Object.html" title="Object (class)">Object</a></span></tt>) <strong>with_session</strong>(*params) {|session| ... }
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Execute a block and save every 'marked' object in a transaction at the end.</p>


  </div>
</div>
<div class="tags">
  
<h3>Yield Parameters:</h3>
<ul class="yieldparam">
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Lims::Core::Persistence::Session (class)">Session</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the created session.</p>
</div>
      
    </li>
  
</ul>
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>the value of the block</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


36
37
38
39
40
41
42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/lims-core/persistence/session.rb', line 36</span>

<span class='kw'>def</span> <span class='id with_session'>with_session</span><span class='lparen'>(</span><span class='op'>*</span><span class='id params'>params</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id block'>block</span><span class='rparen'>)</span>
  <span class='ivar'>@in_session</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id to_return'>to_return</span> <span class='op'>=</span> <span class='id block'>block</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span>
  <span class='ivar'>@in_session</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id save_all'>save_all</span>
  <span class='kw'>return</span> <span class='id to_return'>to_return</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@in_session</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    
  </body>
</html>